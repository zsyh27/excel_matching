# 需求文档 - Excel数据范围选择

## 简介

本文档定义了DDC设备清单匹配报价系统的Excel数据范围选择功能需求。该功能旨在让用户在上传Excel文件后、识别设备行之前，精确指定要处理的工作表、行区间和列区间，从源头上减少噪音数据的干扰，提高后续处理的准确性和效率。

## 术语表

- **系统**: DDC设备清单匹配报价系统
- **数据范围**: 用户指定的Excel工作表、行区间和列区间的组合
- **工作表**: Excel文件中的一个sheet页
- **行区间**: 起始行号到结束行号的范围（包含边界）
- **列区间**: 起始列号到结束列号的范围（包含边界）
- **数据预览**: 显示Excel文件前N行数据的功能
- **范围预览**: 显示用户选择的数据范围的实际内容
- **excel_id**: 上传Excel文件的唯一标识符
- **列字母**: Excel列的字母表示（A, B, C, ..., Z, AA, AB, ...）
- **列索引**: Excel列的数字索引（从1开始）

## 需求

### 需求 1: Excel文件预览

**用户故事:** 作为报价人员，我希望在上传Excel文件后能够预览文件内容，以便了解文件结构并选择正确的数据范围。

#### 验收标准

1. WHEN 用户上传Excel文件成功 THEN 系统 SHALL 自动获取文件的工作表列表
2. WHEN 系统获取工作表列表 THEN 系统 SHALL 返回每个工作表的名称和索引
3. WHEN 系统预览Excel文件 THEN 系统 SHALL 显示前10行数据
4. WHEN 系统显示预览数据 THEN 系统 SHALL 包含行号和列号标识
5. WHEN 系统显示预览数据 THEN 系统 SHALL 保持原始单元格格式（文本、数字、空值）

### 需求 2: 工作表选择

**用户故事:** 作为报价人员，我希望能够选择要处理的工作表，以便只处理包含设备清单的sheet页。

#### 验收标准

1. WHEN Excel文件只有一个工作表 THEN 系统 SHALL 自动选择该工作表
2. WHEN Excel文件有多个工作表 THEN 系统 SHALL 显示工作表选择下拉框
3. WHEN 用户选择工作表 THEN 系统 SHALL 更新数据预览显示该工作表的内容
4. WHEN 用户选择工作表 THEN 系统 SHALL 重置行列范围选择
5. WHEN 系统显示工作表列表 THEN 系统 SHALL 标注每个工作表的行数和列数

### 需求 3: 行范围选择

**用户故事:** 作为报价人员，我希望能够指定要处理的行范围，以便排除表头、页脚等无关行。

#### 验收标准

1. WHEN 用户输入起始行号 THEN 系统 SHALL 验证行号是否在有效范围内（1到最大行数）
2. WHEN 用户输入结束行号 THEN 系统 SHALL 验证结束行号是否大于等于起始行号
3. WHEN 用户未输入结束行号 THEN 系统 SHALL 默认处理到最后一行
4. WHEN 用户输入无效行号 THEN 系统 SHALL 显示错误提示
5. WHEN 用户修改行范围 THEN 系统 SHALL 更新范围预览

### 需求 4: 列范围选择

**用户故事:** 作为报价人员，我希望能够指定要处理的列范围，以便只提取包含设备信息的列。

#### 验收标准

1. WHEN 用户输入起始列 THEN 系统 SHALL 支持列字母（A-Z, AA-ZZ）或列索引（1-N）
2. WHEN 用户输入结束列 THEN 系统 SHALL 验证结束列是否在起始列之后
3. WHEN 用户未输入结束列 THEN 系统 SHALL 默认处理到最后一列
4. WHEN 用户输入无效列标识 THEN 系统 SHALL 显示错误提示
5. WHEN 用户修改列范围 THEN 系统 SHALL 更新范围预览

### 需求 5: 范围预览

**用户故事:** 作为报价人员，我希望能够预览选择的数据范围，以便确认选择是否正确。

#### 验收标准

1. WHEN 用户选择数据范围 THEN 系统 SHALL 实时显示选中范围的数据预览
2. WHEN 系统显示范围预览 THEN 系统 SHALL 高亮显示选中的行列
3. WHEN 系统显示范围预览 THEN 系统 SHALL 显示选中范围的统计信息（行数、列数）
4. WHEN 选中范围超过100行 THEN 系统 SHALL 只预览前100行并提示总行数
5. WHEN 选中范围为空 THEN 系统 SHALL 显示"未选择数据"提示

### 需求 6: 数据范围确认

**用户故事:** 作为报价人员，我希望能够确认选择的数据范围并继续后续处理，以便系统只处理我选择的数据。

#### 验收标准

1. WHEN 用户点击"确认范围"按钮 THEN 系统 SHALL 验证选择的范围是否有效
2. WHEN 范围有效 THEN 系统 SHALL 使用选定范围解析Excel文件
3. WHEN 范围有效 THEN 系统 SHALL 进入设备行识别流程
4. WHEN 范围无效 THEN 系统 SHALL 显示错误提示并阻止继续
5. WHEN 用户未选择范围 THEN 系统 SHALL 使用默认范围（全部工作表、全部行列）

### 需求 7: Excel预览API

**用户故事:** 作为前端开发者，我希望有API接口获取Excel文件预览信息，以便在界面上展示。

#### 验收标准

1. THE 系统 SHALL 提供POST /api/excel/preview接口
2. WHEN 调用预览接口 THEN 系统 SHALL 接收excel_id参数
3. WHEN 调用预览接口 THEN 系统 SHALL 返回工作表列表
4. WHEN 调用预览接口 THEN 系统 SHALL 返回默认工作表的前10行数据
5. WHEN 调用预览接口 THEN 系统 SHALL 返回文件的总行数和总列数
6. WHEN 调用预览接口 THEN 系统 SHALL 返回列字母标识列表
7. WHEN 文件不存在或已过期 THEN 系统 SHALL 返回404错误

### 需求 8: Excel范围解析API

**用户故事:** 作为前端开发者，我希望有API接口使用指定范围解析Excel文件，以便获取处理后的数据。

#### 验收标准

1. THE 系统 SHALL 提供POST /api/excel/parse_range接口
2. WHEN 调用范围解析接口 THEN 系统 SHALL 接收excel_id参数
3. WHEN 调用范围解析接口 THEN 系统 SHALL 接收工作表索引或名称参数
4. WHEN 调用范围解析接口 THEN 系统 SHALL 接收起始行号和结束行号参数（可选）
5. WHEN 调用范围解析接口 THEN 系统 SHALL 接收起始列和结束列参数（可选）
6. WHEN 调用范围解析接口 THEN 系统 SHALL 只解析指定范围内的数据
7. WHEN 调用范围解析接口 THEN 系统 SHALL 返回解析后的行数据
8. WHEN 范围参数无效 THEN 系统 SHALL 返回400错误并说明原因

### 需求 9: 列标识转换

**用户故事:** 作为系统开发者，我希望系统能够正确转换列字母和列索引，以便支持用户的不同输入习惯。

#### 验收标准

1. WHEN 用户输入列字母（如"A"） THEN 系统 SHALL 转换为列索引（1）
2. WHEN 用户输入列字母（如"AA"） THEN 系统 SHALL 转换为列索引（27）
3. WHEN 用户输入列索引（如1） THEN 系统 SHALL 转换为列字母（"A"）
4. WHEN 用户输入列索引（如27） THEN 系统 SHALL 转换为列字母（"AA"）
5. WHEN 转换失败 THEN 系统 SHALL 返回错误信息

### 需求 10: 默认范围行为

**用户故事:** 作为报价人员，我希望系统提供合理的默认范围，以便快速开始处理常见格式的Excel文件。

#### 验收标准

1. WHEN 用户未选择工作表 THEN 系统 SHALL 默认选择第一个工作表
2. WHEN 用户未输入起始行 THEN 系统 SHALL 默认从第1行开始
3. WHEN 用户未输入结束行 THEN 系统 SHALL 默认处理到最后一行
4. WHEN 用户未输入起始列 THEN 系统 SHALL 默认从第1列（A列）开始
5. WHEN 用户未输入结束列 THEN 系统 SHALL 默认处理到最后一列

### 需求 11: 范围选择持久化

**用户故事:** 作为报价人员，我希望系统能够记住我的范围选择，以便在需要重新处理时不用再次选择。

#### 验收标准

1. WHEN 用户确认数据范围 THEN 系统 SHALL 将范围信息与excel_id关联存储
2. WHEN 用户返回范围选择页面 THEN 系统 SHALL 恢复之前的选择
3. WHEN 用户上传新文件 THEN 系统 SHALL 清除之前的范围选择
4. WHEN 范围信息存储失败 THEN 系统 SHALL 不影响正常处理流程
5. WHEN 用户关闭浏览器 THEN 系统 SHALL 保留范围选择（使用sessionStorage）

### 需求 12: 性能优化

**用户故事:** 作为系统开发者，我希望预览和范围选择功能不会显著影响系统性能，以便保证用户体验。

#### 验收标准

1. WHEN 系统预览Excel文件 THEN 系统 SHALL 在1秒内返回预览数据
2. WHEN 系统解析指定范围 THEN 系统 SHALL 只读取指定范围的数据，不加载整个文件
3. WHEN Excel文件超过10MB THEN 系统 SHALL 使用流式读取避免内存溢出
4. WHEN 预览数据超过1000行 THEN 系统 SHALL 限制预览行数并提示
5. WHEN 系统负载高 THEN 系统 SHALL 优先保证核心匹配功能，预览可降级处理

### 需求 13: 错误处理

**用户故事:** 作为报价人员，我希望系统能够清晰提示错误信息，以便快速定位和解决问题。

#### 验收标准

1. WHEN 文件格式不支持 THEN 系统 SHALL 显示"不支持的文件格式"错误
2. WHEN 文件损坏无法读取 THEN 系统 SHALL 显示"文件损坏，无法读取"错误
3. WHEN 工作表不存在 THEN 系统 SHALL 显示"指定的工作表不存在"错误
4. WHEN 行号超出范围 THEN 系统 SHALL 显示"行号超出有效范围（1-N）"错误
5. WHEN 列标识无效 THEN 系统 SHALL 显示"无效的列标识"错误
6. WHEN 范围为空 THEN 系统 SHALL 显示"选择的范围不包含任何数据"错误

### 需求 14: 用户体验优化

**用户故事:** 作为报价人员，我希望范围选择界面简洁易用，以便快速完成选择。

#### 验收标准

1. WHEN 用户打开范围选择页面 THEN 系统 SHALL 自动加载并显示预览数据
2. WHEN 用户输入范围参数 THEN 系统 SHALL 实时验证并显示错误提示
3. WHEN 用户修改范围 THEN 系统 SHALL 实时更新预览（防抖500ms）
4. WHEN 系统显示预览表格 THEN 系统 SHALL 支持横向和纵向滚动
5. WHEN 用户选择常见范围 THEN 系统 SHALL 提供快捷选项（如"跳过第一行"、"只选择前5列"）
