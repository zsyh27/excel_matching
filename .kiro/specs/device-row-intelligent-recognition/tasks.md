# 实施计划 - 设备行智能识别与手动调整

## 任务列表

- [x] 1. 扩展配置文件并创建核心数据模型





  - 在 `data/static_config.json` 中添加设备行识别配置
  - 创建 `backend/modules/device_row_classifier.py` 文件
  - 定义数据模型类：`RowAnalysisResult`、`AnalysisContext`、`ProbabilityLevel`
  - _需求: 1.1, 1.4, 1.5, 4.1, 4.2, 4.3, 4.4, 5.1, 5.2, 5.3, 13.1, 13.2, 13.3_

- [x] 2. 实现三维度评分算法




- [x] 2.1 实现数据类型组合分析

  - 编写 `calculate_data_type_score` 方法
  - 实现文本/数值单元格统计逻辑
  - 实现文本/数值比例评分逻辑
  - 实现空单元格比例扣分逻辑
  - _需求: 1.1, 2.1, 2.2, 2.3, 2.4, 2.5_

- [x] 2.2 实现结构关联性分析

  - 编写 `calculate_structure_score` 方法
  - 实现列标题检测与对齐检查（`_check_header_alignment`）
  - 实现周边行相似度计算（`_calculate_row_similarity`）
  - 实现行位置合理性评估（`_evaluate_row_position`）
  - 实现行模式提取（`_extract_row_pattern`）
  - _需求: 1.2, 3.1, 3.2, 3.3, 3.4, 3.5_

- [x] 2.3 实现行业通用特征分析

  - 编写 `calculate_industry_score` 方法
  - 实现设备类型词库匹配逻辑
  - 实现参数词库匹配逻辑
  - 实现品牌词库匹配逻辑
  - 实现型号模式匹配逻辑
  - _需求: 1.3, 4.1, 4.2, 4.3, 4.4, 4.5, 4.6_

- [x] 2.4 实现综合评分与概率等级划分

  - 编写 `analyze_row` 方法整合三维度评分
  - 实现加权总分计算逻辑
  - 编写 `get_probability_level` 方法
  - 实现判定依据生成（`_generate_reasoning`）
  - _需求: 1.4, 1.5, 5.1, 5.2, 5.3, 5.4, 5.5, 5.6_

- [ ]* 2.5 编写三维度评分算法的单元测试
  - 测试数据类型组合分析的各种场景
  - 测试结构关联性分析的各种场景
  - 测试行业特征分析的各种场景
  - 测试综合评分计算的正确性
  - 测试概率等级划分的阈值逻辑
  - _需求: 1.1, 1.2, 1.3, 1.4, 1.5_

- [x] 3. 实现后端API接口





- [x] 3.1 实现Excel分析接口


  - 在 `backend/app.py` 中添加 `POST /api/excel/analyze` 路由
  - 实现文件接收与excel_id生成逻辑
  - 集成ExcelParser解析Excel文件
  - 集成DeviceRowClassifier进行两遍分析（识别表头 + 分析所有行）
  - 实现分析结果缓存到内存字典
  - 实现统计信息计算
  - 返回符合设计的JSON响应
  - _需求: 6.1, 6.2, 6.3, 6.4, 6.5, 6.6, 6.7, 14.1_

- [x] 3.2 实现手动调整接口

  - 在 `backend/app.py` 中添加 `POST /api/excel/manual-adjust` 路由
  - 实现excel_id验证逻辑
  - 实现手动调整记录保存逻辑（mark_as_device、unmark_as_device、restore_auto）
  - 返回操作成功状态
  - _需求: 7.1, 7.2, 7.3, 7.4, 7.5, 7.6, 14.2_

- [x] 3.3 实现最终设备行获取接口

  - 在 `backend/app.py` 中添加 `GET /api/excel/final-device-rows` 路由
  - 实现手动调整优先的合并逻辑
  - 实现设备行列表生成（包含行号、内容、来源、置信度）
  - 实现统计信息计算
  - 返回最终设备行列表
  - _需求: 8.1, 8.2, 8.3, 8.4, 8.5, 8.6, 14.3_

- [ ]* 3.4 编写API接口的集成测试
  - 测试Excel分析接口的完整流程
  - 测试手动调整接口的各种操作
  - 测试最终设备行获取接口的合并逻辑
  - 测试错误处理场景（无效excel_id、文件损坏等）
  - _需求: 6.1, 7.1, 8.1_

- [x] 4. 检查点 - 确保所有后端测试通过





  - 确保所有测试通过，如有问题请向用户反馈

- [x] 5. 使用真实Excel文件验证识别准确率




- [x] 5.1 创建准确率验证测试


  - 创建 `backend/test_device_row_recognition.py` 测试文件
  - 使用真实文件 `data/(原始表格)建筑设备监控及能源管理报价清单(2).xlsx`
  - 验证自动识别准确率 ≥95%（真实设备行：第6-21行、第23-57行，共51行）
  - 验证手动调整后准确率达到100%
  - _需求: 15.1, 15.2, 15.3, 15.4_

- [x] 5.2 运行准确率验证测试并调优


  - 运行测试并记录准确率结果
  - 如果准确率不达标，调整配置文件中的权重和阈值
  - 如果需要，扩充行业词库
  - 重复测试直到达到≥95%准确率目标
  - _需求: 15.1, 15.5_

- [x] 6. 实现前端DeviceRowAdjustment组件




- [x] 6.1 创建组件基础结构


  - 在 `frontend/src/components/` 中创建 `DeviceRowAdjustment.vue`
  - 实现组件模板结构（工具栏 + 数据表格）
  - 定义组件数据模型（excelId、allRows、filteredRows等）
  - _需求: 9.1, 9.2, 9.3, 9.4, 9.5_

- [x] 6.2 实现概率等级视觉展示

  - 实现 `getRowClassName` 方法根据概率等级设置行样式
  - 定义CSS样式类（浅蓝色、浅黄色、浅灰色、深绿色、深红色）
  - 实现概率等级标签显示（`getProbabilityTagType`、`getProbabilityLabel`）
  - _需求: 9.1, 9.2, 9.3, 9.4, 9.5_

- [x] 6.3 实现单行手动调整功能

  - 为每行添加下拉选择框
  - 实现 `handleManualAdjust` 方法调用API
  - 实现本地状态实时更新
  - 实现操作成功提示
  - _需求: 10.1, 10.2, 10.3, 10.4, 10.5_

- [x] 6.4 实现批量调整功能

  - 为每行添加复选框
  - 实现 `handleSelectionChange` 方法
  - 实现批量标记为设备行（`batchMarkAsDevice`）
  - 实现批量取消设备行（`batchUnmarkAsDevice`）
  - 实现批量操作后的状态更新
  - _需求: 11.1, 11.2, 11.3, 11.4, 11.5_

- [x] 6.5 实现多维度筛选功能

  - 实现行号筛选逻辑
  - 实现列内容关键词筛选逻辑
  - 实现概率等级筛选逻辑
  - 实现筛选条件应用与清除
  - _需求: 12.1, 12.2, 12.3, 12.4, 12.5_

- [x] 6.6 实现确认并进入匹配流程

  - 实现 `confirmAndProceed` 方法
  - 调用最终设备行获取API
  - 触发事件传递数据到匹配流程
  - _需求: 14.4_

- [ ]* 6.7 编写前端组件的单元测试
  - 测试组件渲染正确性
  - 测试单行调整功能
  - 测试批量调整功能
  - 测试筛选功能
  - 测试与API的交互
  - _需求: 9.1, 10.1, 11.1, 12.1_

- [x] 7. 集成前端组件到主应用





- [x] 7.1 更新路由配置


  - 在前端路由中添加设备行调整页面路由
  - 配置路由参数传递（excel_id）
  - _需求: 14.1_

- [x] 7.2 修改上传流程


  - 修改Excel上传成功后的处理逻辑
  - 上传后跳转到设备行调整页面
  - 传递excel_id到调整组件
  - _需求: 14.1_

- [x] 7.3 修改匹配流程入口


  - 修改匹配流程从调整页面接收最终设备行数据
  - 确保数据格式与现有匹配引擎兼容
  - _需求: 14.4_

- [x] 8. 端到端测试与验证




- [x] 8.1 创建端到端测试脚本


  - 创建 `backend/test_e2e_device_row_recognition.py`
  - 测试完整流程：上传 → 分析 → 手动调整 → 获取最终结果 → 匹配 → 导出
  - 使用真实Excel文件验证
  - _需求: 14.1, 14.2, 14.3, 14.4, 14.5_

- [x] 8.2 运行端到端测试


  - 启动后端服务
  - 运行端到端测试脚本
  - 验证所有流程正常工作
  - 验证导出的Excel仅包含最终设备行
  - _需求: 14.5_

- [ ]* 8.3 性能测试
  - 测试单文件分析时间（目标：<2秒，100行以内）
  - 测试内存使用（目标：单excel_id <10MB）
  - 测试并发支持（多用户同时分析不同文件）
  - _需求: 13.4_

- [x] 9. 最终检查点





  - 确保所有测试通过，代码无错误
  - 验证自动识别准确率 ≥95%
  - 验证手动调整后准确率 100%
  - 验证前端交互流畅、提示清晰
  - 验证与现有匹配、导出流程无缝衔接
  - 如有问题，请向用户反馈
  - _需求: 所有需求_

