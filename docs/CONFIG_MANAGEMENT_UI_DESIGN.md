# 配置管理界面设计方案

## 一、需求分析

### 1.1 核心需求
- 在前端界面中可视化编辑所有配置参数
- 实时预览配置修改的效果
- 支持配置的保存、重置、导入导出
- 修改配置后自动重新生成规则
- 提供配置历史版本管理

### 1.2 用户场景
1. **调试阶段**：频繁调整参数，测试不同配置的匹配效果
2. **优化阶段**：根据真实数据反馈，微调配置参数
3. **维护阶段**：添加新的品牌、设备类型、同义词等
4. **回滚场景**：配置修改后效果不佳，需要恢复到之前的版本

## 二、配置分类

### 2.1 核心配置（需要可视化编辑）

#### A. 同义词映射 (synonym_map)
```json
{
  "温度传感器": "温传感器",
  "湿度传感器": "湿传感器"
}
```
**界面设计**：
- 表格形式，两列（原词 → 目标词）
- 支持添加、编辑、删除行
- 支持批量导入（CSV格式）
- 实时搜索和过滤

#### B. 品牌关键词 (brand_keywords)
```json
["霍尼韦尔", "西门子", "江森自控"]
```
**界面设计**：
- 标签云形式显示
- 支持添加、删除
- 支持拖拽排序（影响匹配优先级）
- 分组管理（国产/进口）

#### C. 设备类型关键词 (device_type_keywords)
```json
["传感器", "控制器", "DDC", "阀门"]
```
**界面设计**：
- 分类树形结构
- 支持添加、编辑、删除
- 支持拖拽排序（按长度排序很重要）
- 显示每个关键词的使用频率

#### D. 归一化映射 (normalization_map)
```json
{
  "℃": "",
  "°C": "",
  "~": "-"
}
```
**界面设计**：
- 表格形式，两列（原字符 → 目标字符）
- 分组显示（温度单位、符号、单位等）
- 支持正则表达式
- 显示影响的设备数量

#### E. 特征拆分字符 (feature_split_chars)
```json
["+", ";", "；", "、", "|", "\\", "\n"]
```
**界面设计**：
- 列表形式
- 支持添加、删除、排序
- 显示每个分隔符的使用频率
- 可视化显示分隔符（特殊字符）

#### F. 忽略关键词 (ignore_keywords)
```json
["施工要求", "验收", "图纸"]
```
**界面设计**：
- 标签云形式
- 支持添加、删除
- 显示每个关键词的过滤次数

#### G. 全局配置 (global_config)
```json
{
  "default_match_threshold": 3.0,
  "unify_lowercase": true,
  "remove_whitespace": true,
  "fullwidth_to_halfwidth": true
}
```
**界面设计**：
- 表单形式
- 数值输入框（带滑块）
- 开关按钮（布尔值）
- 实时显示影响范围

### 2.2 高级配置（可选）

#### H. 设备行识别配置 (device_row_recognition)
- 评分权重
- 概率阈值
- 行业关键词

#### I. 性能配置 (performance_config)
- 超时设置
- 最大行数限制

## 三、界面设计方案

### 3.1 页面结构

```
┌─────────────────────────────────────────────────────────┐
│  配置管理                                    [保存] [重置] │
├─────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────────────────────────┐  │
│  │  导航菜单    │  │  配置编辑区域                    │  │
│  │             │  │                                 │  │
│  │ • 同义词映射 │  │  [当前配置内容]                  │  │
│  │ • 品牌关键词 │  │                                 │  │
│  │ • 设备类型   │  │  [编辑表单/表格]                 │  │
│  │ • 归一化映射 │  │                                 │  │
│  │ • 拆分字符   │  │                                 │  │
│  │ • 忽略关键词 │  │                                 │  │
│  │ • 全局配置   │  │                                 │  │
│  │ • 高级配置   │  │                                 │  │
│  │             │  │                                 │  │
│  │ [测试工具]   │  │                                 │  │
│  │ [版本历史]   │  │                                 │  │
│  └─────────────┘  └─────────────────────────────────┘  │
│                                                         │
│  ┌─────────────────────────────────────────────────┐  │
│  │  实时预览区域                                     │  │
│  │  输入测试文本: [___________________________]      │  │
│  │  预处理结果: [显示提取的特征]                     │  │
│  │  匹配结果: [显示匹配的设备]                       │  │
│  └─────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

### 3.2 核心功能模块

#### 模块 1: 配置编辑器
**功能**：
- 可视化编辑各类配置
- 表单验证（格式、重复检查）
- 自动保存草稿
- 撤销/重做功能

**技术实现**：
- Vue 3 + Element Plus / Ant Design Vue
- 表单组件：el-form, el-table, el-tag
- 数据验证：Vuelidate / Yup

#### 模块 2: 实时预览
**功能**：
- 输入测试文本
- 实时显示预处理结果
- 实时显示匹配结果
- 对比修改前后的效果

**技术实现**：
- 防抖处理（避免频繁请求）
- WebSocket 实时通信（可选）
- 差异对比显示

#### 模块 3: 配置管理
**功能**：
- 保存配置到服务器
- 重置到默认配置
- 导入/导出配置（JSON格式）
- 配置验证和错误提示

**技术实现**：
- API: POST /api/config/save
- API: GET /api/config/reset
- API: POST /api/config/import
- API: GET /api/config/export

#### 模块 4: 版本历史
**功能**：
- 显示配置修改历史
- 对比不同版本
- 回滚到历史版本
- 添加版本备注

**技术实现**：
- 数据库表：config_history
- 字段：version, config_data, created_at, remark
- API: GET /api/config/history
- API: POST /api/config/rollback

#### 模块 5: 规则重新生成
**功能**：
- 配置修改后提示重新生成规则
- 显示生成进度
- 生成完成后自动刷新

**技术实现**：
- API: POST /api/rules/regenerate
- 后台任务队列（Celery / RQ）
- WebSocket 推送进度

## 四、后端API设计

### 4.1 配置管理API

#### GET /api/config
获取当前配置
```json
{
  "success": true,
  "config": {
    "synonym_map": {...},
    "brand_keywords": [...],
    ...
  }
}
```

#### POST /api/config/save
保存配置
```json
{
  "config": {...},
  "remark": "添加新品牌关键词"
}
```

#### POST /api/config/validate
验证配置
```json
{
  "config": {...}
}
```
返回：
```json
{
  "success": true,
  "errors": [],
  "warnings": ["同义词映射中存在循环引用"]
}
```

#### GET /api/config/history
获取配置历史
```json
{
  "success": true,
  "history": [
    {
      "version": 1,
      "created_at": "2026-02-26T10:00:00",
      "remark": "初始配置",
      "changes": ["添加10个品牌关键词"]
    }
  ]
}
```

#### POST /api/config/rollback
回滚到指定版本
```json
{
  "version": 5
}
```

#### GET /api/config/export
导出配置（下载JSON文件）

#### POST /api/config/import
导入配置（上传JSON文件）

### 4.2 测试API

#### POST /api/config/test
测试配置效果
```json
{
  "config": {...},
  "test_text": "霍尼韦尔温度传感器"
}
```
返回：
```json
{
  "success": true,
  "preprocessing": {
    "original": "霍尼韦尔温度传感器",
    "features": ["霍尼韦尔", "温传感器", "传感器"]
  },
  "match_result": {
    "device_name": "霍尼韦尔 室内温度传感器",
    "score": 8.0
  }
}
```

### 4.3 规则管理API

#### POST /api/rules/regenerate
重新生成规则
```json
{
  "config": {...}
}
```
返回：
```json
{
  "success": true,
  "task_id": "abc123",
  "message": "规则生成任务已启动"
}
```

#### GET /api/rules/regenerate/status/{task_id}
查询生成进度
```json
{
  "success": true,
  "status": "processing",
  "progress": 45,
  "total": 719,
  "message": "正在生成规则 (45/719)"
}
```

## 五、数据库设计

### 5.1 配置历史表 (config_history)
```sql
CREATE TABLE config_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    version INTEGER NOT NULL,
    config_data TEXT NOT NULL,  -- JSON格式
    remark TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by VARCHAR(100)
);
```

### 5.2 配置变更日志表 (config_change_log)
```sql
CREATE TABLE config_change_log (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    config_version INTEGER NOT NULL,
    change_type VARCHAR(50),  -- add, update, delete
    change_path VARCHAR(200),  -- 例如: synonym_map.温度传感器
    old_value TEXT,
    new_value TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 六、实施步骤

### 阶段 1: 基础功能（1-2天）
1. 创建配置管理页面框架
2. 实现配置读取和显示
3. 实现基本的编辑功能（同义词映射、品牌关键词）
4. 实现配置保存API

### 阶段 2: 核心功能（2-3天）
1. 实现所有配置项的编辑界面
2. 实现实时预览功能
3. 实现配置验证
4. 实现规则重新生成功能

### 阶段 3: 高级功能（2-3天）
1. 实现版本历史管理
2. 实现配置导入/导出
3. 实现配置对比功能
4. 实现批量操作

### 阶段 4: 优化和测试（1-2天）
1. 性能优化
2. 用户体验优化
3. 错误处理和提示
4. 完整测试

## 七、技术栈建议

### 前端
- **框架**: Vue 3 + TypeScript
- **UI组件库**: Element Plus / Ant Design Vue
- **状态管理**: Pinia
- **HTTP客户端**: Axios
- **表单验证**: Vuelidate / Yup
- **代码编辑器**: Monaco Editor（用于JSON编辑）

### 后端
- **框架**: Flask（已有）
- **任务队列**: Celery / RQ（用于异步规则生成）
- **数据库**: SQLite（已有）
- **配置管理**: 扩展现有的 ConfigManager

## 八、用户体验优化

### 8.1 智能提示
- 输入品牌关键词时，提示已存在的品牌
- 输入同义词时，检测循环引用
- 修改配置时，显示影响的设备数量

### 8.2 可视化反馈
- 配置修改后，高亮显示变更部分
- 实时预览区域使用颜色标记匹配的特征
- 显示配置修改的影响范围（多少设备受影响）

### 8.3 快捷操作
- 常用配置的快速模板
- 批量添加（从CSV导入）
- 一键恢复默认配置
- 配置搜索和过滤

### 8.4 错误处理
- 友好的错误提示
- 配置验证失败时，高亮错误位置
- 提供修复建议

## 九、安全考虑

### 9.1 权限控制
- 配置修改需要管理员权限
- 记录所有配置变更的操作者
- 敏感配置需要二次确认

### 9.2 数据备份
- 每次保存配置前自动备份
- 保留最近30天的配置历史
- 支持手动创建备份点

### 9.3 配置验证
- 防止注入攻击（JSON验证）
- 检查配置的合法性
- 限制配置文件大小

## 十、后续扩展

### 10.1 智能推荐
- 根据匹配日志，推荐需要添加的同义词
- 分析失败案例，推荐配置优化方案
- 自动学习常见的词汇变体

### 10.2 A/B测试
- 支持多套配置方案
- 对比不同配置的匹配效果
- 自动选择最优配置

### 10.3 配置分享
- 导出配置为可分享的链接
- 从社区导入优化的配置
- 配置评分和评论

## 十一、总结

### 优势
1. **提高效率**：无需修改代码，快速调整参数
2. **降低门槛**：非技术人员也能优化配置
3. **可追溯性**：完整的配置历史记录
4. **安全性**：配置验证和备份机制
5. **可视化**：实时预览配置效果

### 投入产出比
- **开发时间**：约 6-10 天
- **维护成本**：低（配置界面稳定后很少需要修改）
- **收益**：显著提高配置调整效率，减少错误

### 建议
1. **优先实现**：同义词映射、品牌关键词、设备类型关键词的编辑
2. **逐步完善**：先实现基础功能，再添加高级功能
3. **用户反馈**：根据实际使用情况，持续优化界面和功能

这个配置管理界面将成为系统的核心工具，极大地提高配置调整和优化的效率！
