# 元数据处理机制说明

## 问题背景

用户在匹配详情页面的"智能清理"阶段看到了类似 `"\d+\.?施工要求[:：]"` 这样的分隔符模式，并询问：
1. 这是什么意思？
2. 为什么"规格参数"和"工作原理"不能直接添加到配置管理页面的"元数据关键词"中？

## 两种元数据处理方法

系统中有**两种不同的元数据处理方法**，它们的用途和配置位置都不同：

### 方法1: `_remove_metadata_prefix()` - 删除元数据关键词前缀

**用途**: 删除冒号前的字段名，只保留冒号后的值

**配置位置**: `metadata_keywords` (配置管理页面的"元数据关键词")

**处理逻辑**:
```python
# 例如: "型号:QAA2061" → "QAA2061"
# 例如: "品牌:霍尼韦尔" → "霍尼韦尔"
# 例如: "规格参数:0-2000ppm" → "0-2000ppm"
```

**适用场景**: 
- 简单的"字段名:值"格式
- 字段名是固定的词汇，不带数字序号
- 例如: "型号:xxx", "品牌:xxx", "规格:xxx"

**配置示例**:
```json
{
  "metadata_keywords": [
    "型号",
    "品牌",
    "规格",
    "参数",
    "名称",
    "规格参数"  // 可以添加这个
  ]
}
```

### 方法2: `_remove_metadata_labels()` - 删除元数据标签

**用途**: 删除带序号或复杂格式的标签

**配置位置**: `intelligent_extraction.metadata_label_patterns` (目前配置管理页面没有对应编辑器)

**处理逻辑**:
```python
# 例如: "1.名称:室内CO2传感器" → "室内CO2传感器"
# 例如: "2.规格参数:0-2000ppm" → "0-2000ppm"
# 例如: "工作原理:电化学式" → "电化学式"
```

**适用场景**:
- 带数字序号的标签: "1.名称:", "2.规格参数:"
- 需要正则表达式匹配的复杂模式
- 例如: "\\d+\\.?规格参数[:：]" 匹配 "1.规格参数:", "2规格参数：" 等

**配置示例**:
```json
{
  "intelligent_extraction": {
    "metadata_label_patterns": [
      "\\d+\\.?名称[:：]",
      "\\d+\\.?规格[:：]",
      "\\d+\\.?规格参数[:：]",  // 带序号的规格参数
      "\\d+\\.?施工要求[:：]",  // 带序号的施工要求
      "工作原理[:：]?"          // 不带序号的工作原理
    ]
  }
}
```

## 回答用户的问题

### Q1: `"\d+\.?施工要求[:：]"` 是什么意思？

这是一个**正则表达式模式**，用于匹配带序号的"施工要求"标签：

- `\d+` - 匹配一个或多个数字（如 1, 2, 10）
- `\.?` - 匹配可选的点号（如 "1." 或 "1"）
- `施工要求` - 匹配文字"施工要求"
- `[:：]` - 匹配中文或英文冒号

**匹配示例**:
- ✅ "1.施工要求:" 
- ✅ "2施工要求："
- ✅ "10.施工要求:"
- ❌ "施工要求:" (没有数字序号，不匹配)

### Q2: 为什么"规格参数"和"工作原理"不能在"元数据关键词"中添加？

**答案**: 可以添加，但要看你的数据格式！

#### 情况1: 数据没有数字序号

如果你的数据是这样的：
```
规格参数:0-2000ppm
工作原理:电化学式
```

那么**可以直接添加到"元数据关键词"**中：
```json
{
  "metadata_keywords": [
    "规格参数",
    "工作原理"
  ]
}
```

#### 情况2: 数据有数字序号

如果你的数据是这样的：
```
1.规格参数:0-2000ppm
2.工作原理:电化学式
```

那么**必须使用正则表达式模式**（`metadata_label_patterns`），因为：
- "规格参数" 不能匹配 "1.规格参数"
- 需要用 `\d+\.?规格参数[:：]` 来匹配带序号的格式

## 处理顺序

在智能清理阶段，两种方法的执行顺序是：

1. **截断** - 在噪音分隔符处截断
2. **删除噪音段落** - 删除匹配噪音模式的段落
3. **删除元数据标签** - 使用 `metadata_label_patterns`（正则表达式）
4. **统一分隔符** - 将分隔符统一为标准分隔符

然后在**特征提取阶段**：

5. **删除元数据前缀** - 使用 `metadata_keywords`（简单字符串匹配）

## 建议

### 对于用户的数据

请检查你的Excel数据中"规格参数"和"工作原理"的格式：

1. **如果没有数字序号** (如 "规格参数:xxx")
   - 在配置管理页面的"元数据关键词"中添加"规格参数"和"工作原理"
   - 从 `metadata_label_patterns` 中删除对应的正则表达式

2. **如果有数字序号** (如 "2.规格参数:xxx")
   - 保留 `metadata_label_patterns` 中的正则表达式
   - 不需要在"元数据关键词"中添加

### 配置管理页面改进建议

目前配置管理页面没有"元数据标签模式"编辑器，只有"元数据关键词"编辑器。

建议未来添加一个新的编辑器组件，用于管理 `intelligent_extraction.metadata_label_patterns`。

## 总结

| 特性 | 元数据关键词 | 元数据标签模式 |
|------|------------|--------------|
| 配置字段 | `metadata_keywords` | `intelligent_extraction.metadata_label_patterns` |
| 匹配方式 | 简单字符串匹配 | 正则表达式匹配 |
| 适用场景 | "字段名:值" | "1.字段名:值" 或复杂格式 |
| 配置管理页面 | ✅ 有编辑器 | ❌ 没有编辑器 |
| 处理阶段 | 特征提取阶段 | 智能清理阶段 |
| 示例 | "型号:QAA2061" | "1.名称:传感器" |
