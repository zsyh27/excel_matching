# 预处理分析总结

## 问题回答

### 是否要在 static_config.json 和程序中区别对待设备库数据和需要匹配的数据？

**答案：不需要！**

## 理由

### 1. 当前实现是正确的
- 设备库数据在生成规则时已经被预处理过
- 匹配数据需要经过相同的预处理才能匹配上
- 两者使用相同的预处理逻辑保证了一致性

### 2. 测试验证
```
输入: "温度传感器，0-50℃，4-20mA"
预处理结果: ['温度传感器', '0-50', '4-20ma']
```
- ✓ 逗号正确转换为分隔符
- ✓ "℃" 正确删除
- ✓ 特征正确拆分

### 3. 真正的问题不是预处理

测试发现的真正问题：

#### 问题 1: 特征拆分不够细致
```
输入: "霍尼韦尔室内温度传感器，NTC10K，室内墙装"
提取特征: ['霍尼韦尔室内温度传感器', 'ntc10k', '室内墙装']
                ↑
         这是一个整体，无法匹配！
```

**规则中的特征**：
- "霍尼韦尔" (独立)
- "室内温传感器" (独立)

**用户输入的特征**：
- "霍尼韦尔室内温度传感器" (整体)

**结果**：无法匹配！

#### 问题 2: 词汇不匹配
```
用户输入: "温度传感器"
规则特征: "室内温传感器"  (注意："度"已被删除)
结果: 不匹配
```

## 解决方案

### 方案 A: 改进特征拆分（推荐）

在预处理时，将品牌和设备类型分开：

```python
# 当前
"霍尼韦尔室内温度传感器" → ["霍尼韦尔室内温度传感器"]

# 改进
"霍尼韦尔室内温度传感器" → ["霍尼韦尔", "室内", "温度", "传感器", "室内温度传感器"]
```

**实现方式**：
1. 识别品牌关键词（从配置文件加载）
2. 识别设备类型关键词（传感器、控制器、阀门等）
3. 将长字符串拆分为多个有意义的子特征

### 方案 B: 添加同义词映射

在 `static_config.json` 中添加：

```json
{
  "synonym_map": {
    "温度传感器": "温传感器",
    "湿度传感器": "湿传感器",
    "室内温度传感器": "室内温传感器"
  }
}
```

### 方案 C: 使用部分匹配

修改匹配引擎，支持子字符串匹配：

```python
# 当前: 精确匹配
if feature in rule.feature_weights:
    score += rule.feature_weights[feature]

# 改进: 部分匹配
for rule_feature in rule.feature_weights:
    if rule_feature in feature:  # 规则特征是输入特征的子串
        score += rule.feature_weights[rule_feature]
```

## 推荐实施顺序

### 第一步：改进特征拆分（方案 A）
这是最根本的解决方案，可以提高整体匹配准确率。

**修改位置**：
- `backend/modules/text_preprocessor.py` 的 `extract_features()` 方法
- 添加品牌识别和设备类型识别逻辑

### 第二步：添加同义词映射（方案 B）
作为补充，处理常见的词汇变体。

**修改位置**：
- `data/static_config.json` 添加 `synonym_map` 配置
- `backend/modules/text_preprocessor.py` 的 `normalize_text()` 方法

### 第三步：实现部分匹配（方案 C）
作为兜底机制，提高匹配覆盖率。

**修改位置**：
- `backend/modules/match_engine.py` 的 `calculate_weight_score()` 方法

## 测试用例

### 测试 1: 简短描述
```
输入: "温度传感器，0-50℃，4-20mA"
当前结果: 匹配失败（得分 1.0）
期望结果: 匹配成功（通过同义词映射或部分匹配）
```

### 测试 2: 完整描述
```
输入: "霍尼韦尔室内温度传感器，NTC10K，室内墙装"
当前结果: 匹配失败（得分 4.0，差 1 分）
期望结果: 匹配成功（通过改进特征拆分）
```

### 测试 3: 品牌+类型
```
输入: "霍尼韦尔温度传感器"
当前结果: 匹配失败（得分 0.0）
期望结果: 匹配成功（通过改进特征拆分）
```

## 结论

1. **不需要区别对待设备库数据和匹配数据**
2. **当前的预处理逻辑是正确的**
3. **真正的问题是特征拆分不够细致**
4. **建议优先实现方案 A（改进特征拆分）**

## 下一步行动

1. 实现品牌识别和设备类型识别
2. 改进 `extract_features()` 方法，生成多层次特征
3. 测试验证改进效果
4. 根据测试结果调整策略
