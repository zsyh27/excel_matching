<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ResultTable 组件测试</title>
  <style>
    body {
      font-family: 'Microsoft YaHei', Arial, sans-serif;
      padding: 20px;
      background-color: #f5f7fa;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.1);
    }
    h1 {
      color: #409EFF;
      border-bottom: 2px solid #409EFF;
      padding-bottom: 10px;
    }
    .test-section {
      margin: 20px 0;
      padding: 15px;
      background: #f9f9f9;
      border-left: 4px solid #409EFF;
    }
    .test-section h2 {
      margin-top: 0;
      color: #303133;
    }
    button {
      background: #409EFF;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #66b1ff;
    }
    button:disabled {
      background: #c0c4cc;
      cursor: not-allowed;
    }
    .result {
      margin-top: 10px;
      padding: 10px;
      background: white;
      border-radius: 4px;
      border: 1px solid #dcdfe6;
    }
    .success {
      color: #67c23a;
    }
    .error {
      color: #f56c6c;
    }
    .info {
      color: #909399;
    }
    pre {
      background: #f5f7fa;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      max-height: 400px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ResultTable 组件 API 测试</h1>
    
    <div class="test-section">
      <h2>测试说明</h2>
      <p>此页面用于测试 ResultTable 组件所依赖的后端 API 接口。</p>
      <p><strong>前提条件</strong>: 确保后端服务已启动 (python backend/app.py)</p>
    </div>

    <div class="test-section">
      <h2>1. 测试获取设备列表 (GET /api/devices)</h2>
      <button onclick="testGetDevices()">测试获取设备列表</button>
      <div id="devices-result" class="result"></div>
    </div>

    <div class="test-section">
      <h2>2. 测试文件上传和解析</h2>
      <input type="file" id="file-input" accept=".xls,.xlsx,.xlsm">
      <button onclick="testUploadAndParse()">上传并解析</button>
      <div id="upload-result" class="result"></div>
    </div>

    <div class="test-section">
      <h2>3. 测试设备匹配 (POST /api/match)</h2>
      <button id="match-btn" onclick="testMatch()" disabled>测试匹配</button>
      <div id="match-result" class="result"></div>
    </div>

    <div class="test-section">
      <h2>4. 测试导出 (POST /api/export)</h2>
      <button id="export-btn" onclick="testExport()" disabled>测试导出</button>
      <div id="export-result" class="result"></div>
    </div>
  </div>

  <script>
    const API_BASE = 'http://localhost:5000/api';
    let currentFileId = null;
    let parseResult = null;
    let matchedRows = null;

    // 测试获取设备列表
    async function testGetDevices() {
      const resultDiv = document.getElementById('devices-result');
      resultDiv.innerHTML = '<p class="info">正在获取设备列表...</p>';

      try {
        const response = await fetch(`${API_BASE}/devices`);
        const data = await response.json();

        if (data.success) {
          resultDiv.innerHTML = `
            <p class="success">✓ 获取设备列表成功</p>
            <p>设备数量: ${data.devices.length}</p>
            <pre>${JSON.stringify(data.devices.slice(0, 3), null, 2)}</pre>
            <p class="info">... (仅显示前3个设备)</p>
          `;
        } else {
          resultDiv.innerHTML = `<p class="error">✗ 获取失败: ${data.error_message}</p>`;
        }
      } catch (error) {
        resultDiv.innerHTML = `<p class="error">✗ 请求失败: ${error.message}</p>`;
      }
    }

    // 测试上传和解析
    async function testUploadAndParse() {
      const fileInput = document.getElementById('file-input');
      const resultDiv = document.getElementById('upload-result');
      
      if (!fileInput.files.length) {
        resultDiv.innerHTML = '<p class="error">请先选择文件</p>';
        return;
      }

      const file = fileInput.files[0];
      resultDiv.innerHTML = '<p class="info">正在上传文件...</p>';

      try {
        // 上传文件
        const formData = new FormData();
        formData.append('file', file);

        const uploadResponse = await fetch(`${API_BASE}/upload`, {
          method: 'POST',
          body: formData
        });
        const uploadData = await uploadResponse.json();

        if (!uploadData.success) {
          resultDiv.innerHTML = `<p class="error">✗ 上传失败: ${uploadData.error_message}</p>`;
          return;
        }

        currentFileId = uploadData.file_id;
        resultDiv.innerHTML = `<p class="success">✓ 上传成功: ${uploadData.filename}</p>`;
        resultDiv.innerHTML += '<p class="info">正在解析文件...</p>';

        // 解析文件
        const parseResponse = await fetch(`${API_BASE}/parse`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ file_id: currentFileId })
        });
        const parseData = await parseResponse.json();

        if (parseData.success) {
          parseResult = parseData.parse_result;
          resultDiv.innerHTML = `
            <p class="success">✓ 解析成功</p>
            <p>总行数: ${parseResult.total_rows}</p>
            <p>有效行数: ${parseResult.valid_rows}</p>
            <p>设备行数: ${parseResult.device_rows}</p>
            <pre>${JSON.stringify(parseResult.rows.slice(0, 3), null, 2)}</pre>
            <p class="info">... (仅显示前3行)</p>
          `;
          document.getElementById('match-btn').disabled = false;
        } else {
          resultDiv.innerHTML += `<p class="error">✗ 解析失败: ${parseData.error_message}</p>`;
        }
      } catch (error) {
        resultDiv.innerHTML = `<p class="error">✗ 请求失败: ${error.message}</p>`;
      }
    }

    // 测试匹配
    async function testMatch() {
      const resultDiv = document.getElementById('match-result');
      
      if (!parseResult) {
        resultDiv.innerHTML = '<p class="error">请先上传并解析文件</p>';
        return;
      }

      resultDiv.innerHTML = '<p class="info">正在匹配设备...</p>';

      try {
        const response = await fetch(`${API_BASE}/match`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ rows: parseResult.rows })
        });
        const data = await response.json();

        if (data.success) {
          matchedRows = data.matched_rows;
          const stats = data.statistics;
          
          resultDiv.innerHTML = `
            <p class="success">✓ 匹配完成</p>
            <p>总设备数: ${stats.total_devices}</p>
            <p>匹配成功: <span class="success">${stats.matched}</span></p>
            <p>匹配失败: <span class="error">${stats.unmatched}</span></p>
            <p>准确率: ${stats.accuracy_rate}%</p>
            <pre>${JSON.stringify(matchedRows.slice(0, 3), null, 2)}</pre>
            <p class="info">... (仅显示前3个结果)</p>
          `;
          document.getElementById('export-btn').disabled = false;
        } else {
          resultDiv.innerHTML = `<p class="error">✗ 匹配失败: ${data.error_message}</p>`;
        }
      } catch (error) {
        resultDiv.innerHTML = `<p class="error">✗ 请求失败: ${error.message}</p>`;
      }
    }

    // 测试导出
    async function testExport() {
      const resultDiv = document.getElementById('export-result');
      
      if (!currentFileId || !matchedRows) {
        resultDiv.innerHTML = '<p class="error">请先完成上传、解析和匹配</p>';
        return;
      }

      resultDiv.innerHTML = '<p class="info">正在导出报价清单...</p>';

      try {
        const response = await fetch(`${API_BASE}/export`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            file_id: currentFileId,
            matched_rows: matchedRows
          })
        });

        if (response.ok) {
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `报价清单_测试_${Date.now()}.xlsx`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);

          resultDiv.innerHTML = `
            <p class="success">✓ 导出成功</p>
            <p>文件已自动下载</p>
          `;
        } else {
          const data = await response.json();
          resultDiv.innerHTML = `<p class="error">✗ 导出失败: ${data.error_message}</p>`;
        }
      } catch (error) {
        resultDiv.innerHTML = `<p class="error">✗ 请求失败: ${error.message}</p>`;
      }
    }
  </script>
</body>
</html>
