# RuleEditor 组件文档

## 概述

RuleEditor 是规则编辑组件，用于查看和编辑设备匹配规则的详细配置，包括匹配阈值、特征权重等。

## 功能特性

### 1. 设备基本信息展示
- 显示设备ID、规则ID、品牌、设备名称、规格型号
- 显示详细参数和单价
- 显示特征数量统计

### 2. 匹配阈值编辑
- 使用数字输入框调整匹配阈值
- 支持 0-100 范围，步长 0.5
- 实时显示阈值状态提示：
  - 阈值 < 3: 红色警告，提示"阈值过低，可能导致误匹配"
  - 阈值 3-5: 黄色警告，提示"阈值适中，建议根据实际情况调整"
  - 阈值 ≥ 5: 绿色成功，提示"阈值合理，能有效避免误匹配"

### 3. 特征列表和权重编辑
- 表格展示所有特征及其权重
- 支持实时编辑权重值（0-10，步长 0.5）
- 按权重从高到低自动排序
- 显示特征类型标签（品牌/设备类型/型号/参数）
- 支持删除特征

### 4. 添加新特征
- 点击"添加特征"按钮打开对话框
- 输入特征名称、权重和类型
- 自动检查特征是否已存在
- 添加后自动排序

### 5. 批量调整权重
- 支持按特征类型批量调整权重
- 可选类型：全部/品牌/设备类型/型号/参数
- 一次性调整多个特征的权重值

### 6. 重置为默认
- 一键恢复到初始加载时的配置
- 需要确认操作，防止误操作

### 7. 权重分布图表
- 使用 ECharts 柱状图展示特征权重分布
- 颜色编码：
  - 红色：权重 ≥ 5（高权重）
  - 橙色：权重 3-5（中权重）
  - 蓝色：权重 < 3（低权重）
- 自动适应窗口大小变化

### 8. 保存和取消
- 保存按钮：提交修改到后端
- 取消按钮：放弃修改并返回
- 保存成功后自动返回规则列表

## 组件属性

### Props

| 属性名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| ruleId | String | 是 | 规则ID，用于加载规则详情 |

### Events

| 事件名 | 参数 | 说明 |
|--------|------|------|
| save | - | 保存成功时触发 |
| cancel | - | 取消编辑时触发 |

## 使用示例

### 在视图中使用

```vue
<template>
  <div class="rule-editor-view">
    <RuleEditor
      :rule-id="ruleId"
      @save="handleSave"
      @cancel="handleCancel"
    />
  </div>
</template>

<script setup>
import { useRouter, useRoute } from 'vue-router'
import RuleEditor from '../components/RuleManagement/RuleEditor.vue'

const router = useRouter()
const route = useRoute()
const ruleId = route.params.ruleId

const handleSave = () => {
  console.log('规则已保存')
  router.push('/rule-management')
}

const handleCancel = () => {
  router.push('/rule-management')
}
</script>
```

## API 接口

### 获取规则详情

```
GET /api/rules/management/{rule_id}

Response:
{
  "success": true,
  "rule": {
    "rule_id": "R_SENSOR001",
    "device_id": "SENSOR001",
    "device_info": {
      "device_id": "SENSOR001",
      "brand": "霍尼韦尔",
      "device_name": "温度传感器",
      "spec_model": "HST-RA",
      "detailed_params": "0-50℃,4-20mA,0-10V",
      "unit_price": 213.0
    },
    "match_threshold": 5.0,
    "features": [
      {
        "feature": "霍尼韦尔",
        "weight": 3.0,
        "type": "brand"
      },
      {
        "feature": "温度传感器",
        "weight": 5.0,
        "type": "device_type"
      }
    ],
    "remark": "温度传感器匹配规则"
  }
}
```

### 更新规则

```
PUT /api/rules/management/{rule_id}

Request:
{
  "match_threshold": 5.0,
  "features": [
    {"feature": "霍尼韦尔", "weight": 3.0},
    {"feature": "温度传感器", "weight": 5.0}
  ]
}

Response:
{
  "success": true,
  "message": "规则更新成功",
  "updated_rule": {
    "rule_id": "R_SENSOR001",
    "match_threshold": 5.0,
    "feature_count": 2
  }
}
```

## 数据流程

1. **加载规则**
   - 组件挂载时调用 `fetchRuleDetail()`
   - 从后端获取规则详情
   - 保存原始数据用于重置功能
   - 渲染权重分布图表

2. **编辑操作**
   - 修改阈值：实时更新，无需额外操作
   - 修改权重：自动重新排序，更新图表
   - 添加特征：验证后添加到列表，更新图表
   - 删除特征：确认后从列表移除，更新图表
   - 批量调整：按类型批量更新权重，更新图表

3. **保存修改**
   - 构造请求数据（阈值 + 特征列表）
   - 调用 PUT 接口提交到后端
   - 成功后更新原始数据，触发 save 事件
   - 失败时显示错误消息

4. **重置操作**
   - 从原始数据恢复阈值和特征列表
   - 更新图表显示

## 样式说明

- 使用 Element Plus 组件库的默认样式
- 图表容器高度固定为 400px
- 响应式布局，适配不同屏幕尺寸
- 操作按钮右对齐，保持一致性

## 注意事项

1. **权重范围**：权重值限制在 0-10 之间，步长 0.5
2. **阈值范围**：阈值限制在 0-100 之间，步长 0.5
3. **特征唯一性**：添加特征时会检查是否已存在
4. **自动排序**：特征列表始终按权重从高到低排序
5. **图表更新**：任何权重变化都会自动更新图表
6. **窗口调整**：图表会自动适应窗口大小变化

## 验证需求

该组件实现了以下需求：

- **需求 10.2**: 显示设备详细匹配规则，包含所有提取的特征及其权重值
- **需求 10.3**: 按权重值从高到低排序显示特征列表
- **需求 10.4**: 修改某个特征的权重值，实时更新规则并保存到数据库
- **需求 10.5**: 修改规则的匹配阈值，实时更新规则并保存到数据库
- **需求 10.12**: 批量操作功能，支持按特征类型统一调整权重
- **需求 10.13**: 重置功能，将规则恢复到自动生成的初始状态
- **需求 10.14**: 显示当前所有规则的权重分布图表

## 未来改进

1. 支持特征类型的自动识别和建议
2. 添加权重调整的历史记录
3. 提供权重优化建议
4. 支持批量导入/导出规则配置
5. 添加规则测试功能的快速入口
