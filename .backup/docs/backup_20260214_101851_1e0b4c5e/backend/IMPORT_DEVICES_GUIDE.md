# 设备数据导入指南

## 概述

`import_devices_from_excel.py` 脚本用于从Excel文件导入设备数据到数据库。

## 功能特性

1. **自动识别表头**: 智能识别Excel文件中的表头行
2. **灵活的列映射**: 支持多种列名格式（中文/英文）
3. **数据验证和清洗**: 自动验证和清洗数据
4. **批量导入**: 支持大批量数据的高效导入
5. **更新已存在设备**: 自动检测并更新已存在的设备
6. **详细统计报告**: 提供完整的导入统计信息

## 使用方法

### 基本用法

```bash
cd backend
python import_devices_from_excel.py
```

默认会导入 `../data/真实设备价格例子.xlsx` 文件到配置的数据库。

### 指定Excel文件

```bash
python import_devices_from_excel.py --excel /path/to/your/devices.xlsx
```

### 指定数据库

```bash
python import_devices_from_excel.py --db-url "sqlite:///path/to/database.db"
```

### 调整批量大小

```bash
python import_devices_from_excel.py --batch-size 50
```

### 完整示例

```bash
python import_devices_from_excel.py \
  --excel "../data/真实设备价格例子.xlsx" \
  --db-url "sqlite:///D:/excel_matching/data/devices.db" \
  --batch-size 100
```

## Excel文件格式要求

### 必需列

脚本会自动识别以下列（支持中英文）：

1. **设备ID** (device_id, 编号, 序号)
2. **品牌** (brand, 品牌)
3. **设备名称** (device_name, 设备名称, 名称) - **必需**
4. **规格型号** (spec_model, 规格, 型号)
5. **详细参数** (detailed_params, 参数, 详细)
6. **单价** (unit_price, 单价, 价格)

### 示例格式

| 设备ID | 品牌 | 设备名称 | 规格型号 | 详细参数 | 单价 |
|--------|------|----------|----------|----------|------|
| SENSOR001 | 霍尼韦尔 | CO传感器 | HW-CO-01 | 测量范围0-1000ppm | 766.14 |
| SENSOR002 | 西门子 | 温度传感器 | QAA2012 | -50~50℃ | 320.50 |

### 数据处理规则

1. **设备ID**: 如果为空，自动生成 `AUTO_行号`
2. **品牌**: 如果为空，设置为 "未知品牌"
3. **设备名称**: 必需字段，为空则跳过该行
4. **规格型号**: 可选，为空则设置为空字符串
5. **详细参数**: 可选，为空则设置为空字符串
6. **单价**: 自动清洗（移除货币符号、逗号），无效值设置为0.0

## 导入行为

### 新设备

如果设备ID不存在，会插入新设备记录。

### 已存在设备

如果设备ID已存在，会更新该设备的所有字段（除了device_id）。

### 批量处理

- 默认批量大小: 100条记录
- 使用事务确保数据一致性
- 单条记录失败不影响其他记录

## 统计报告

导入完成后会显示详细的统计报告：

```
================================================================================
设备导入统计报告
================================================================================
总行数:           719
有效行数:         719
跳过行数:         0
插入设备数:       719
更新设备数:       0
错误数:           0
================================================================================
```

### 报告字段说明

- **总行数**: Excel中的数据行总数（不含表头）
- **有效行数**: 成功解析的行数
- **跳过行数**: 因数据无效而跳过的行数
- **插入设备数**: 新插入的设备数量
- **更新设备数**: 更新的已存在设备数量
- **错误数**: 导入过程中的错误数量

## 常见问题

### 1. 找不到表头行

脚本会自动查找包含关键字（设备、品牌、价格等）的行作为表头。如果找不到，会使用默认列映射（A-F列）。

### 2. 价格格式错误

脚本会自动清洗价格字段，移除货币符号（¥、￥）和逗号。无法解析的价格会设置为0.0。

### 3. 设备名称为空

设备名称是必需字段，为空的行会被跳过并记录在统计报告中。

### 4. 数据库连接失败

确保：
- 数据库文件路径正确
- 有写入权限
- SQLite文件所在目录存在

## 测试

运行测试脚本验证功能：

```bash
python test_import_devices.py
```

## 验证需求

该脚本实现了以下需求：

- **需求 2.1**: 提供Excel导入方式
- **需求 2.2**: 读取真实设备价格例子.xlsx文件
- **需求 2.3**: 提取设备数据（device_id, brand, device_name, spec_model, detailed_params, unit_price）
- **需求 2.4**: 数据验证和清洗
- **需求 2.5**: 批量插入到数据库
- **需求 2.6**: 更新已存在的设备记录

## 相关文件

- `import_devices_from_excel.py` - 主导入脚本
- `test_import_devices.py` - 测试脚本
- `modules/database.py` - 数据库管理器
- `modules/models.py` - ORM模型定义
