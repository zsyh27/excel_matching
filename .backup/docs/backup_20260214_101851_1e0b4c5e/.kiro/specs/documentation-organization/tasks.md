# 实现计划: 文档整理功能

## 概述

本实现计划将文档整理功能设计转换为可执行的开发任务。系统将使用 Python 实现，提供命令行工具和配置文件驱动的文档整理能力。

## 任务

- [x] 1. 创建项目结构和核心数据模型
  - 创建 `organize_docs/` 目录作为功能模块
  - 实现 Document 数据类（文件名、路径、大小、修改时间等）
  - 实现 DocumentCategory 枚举（CORE、ARCHIVE、DEVELOPMENT、UNKNOWN）
  - 实现配置数据类（ClassificationConfig、DirectoryStructure 等）
  - _需求: 1.1, 1.2, 2.1_

- [ ] 2. 实现配置管理器
  - [x] 2.1 实现配置文件加载功能
    - 读取 JSON 配置文件
    - 解析配置项（分类规则、目录结构、归档分组等）
    - _需求: 12.1, 12.2_
  
  - [ ]* 2.2 编写配置加载的单元测试
    - 测试有效配置加载
    - 测试缺少字段的处理
    - _需求: 12.1_
  
  - [x] 2.3 实现配置验证功能
    - 验证必需字段存在
    - 验证字段类型正确
    - 验证路径格式有效
    - _需求: 12.5_
  
  - [ ]* 2.4 编写配置验证的属性测试
    - **属性 22: 配置格式验证**
    - **验证: 需求 12.5**
    - 生成随机配置，测试验证器能检测格式错误
  
  - [x] 2.5 实现默认配置生成
    - 提供默认配置模板
    - 支持生成配置文件到指定路径
    - _需求: 12.4_

- [ ] 3. 实现文档扫描器
  - [x] 3.1 实现目录扫描功能
    - 递归扫描指定目录
    - 识别所有 .md 文件
    - 排除配置的排除目录（node_modules、.git 等）
    - 收集文档元数据（大小、修改时间等）
    - _需求: 1.1_
  
  - [ ]* 3.2 编写扫描器的属性测试
    - **属性 1: 文档扫描完整性**
    - **验证: 需求 1.1**
    - 创建随机数量的 MD 文件，验证扫描器找到所有文件
  
  - [ ]* 3.3 编写扫描器的单元测试
    - 测试空目录扫描
    - 测试排除目录功能
    - 测试文件元数据收集

- [ ] 4. 实现文档分类器
  - [x] 4.1 实现核心文档识别
    - 根据文件名匹配核心文档（README.md、SETUP.md 等）
    - 根据路径匹配核心文档（.kiro/PROJECT.md）
    - _需求: 1.4, 5.1-5.5_
  
  - [x] 4.2 实现归档文档识别
    - 根据文件名关键词识别（SUMMARY、REPORT、COMPLETION 等）
    - 根据文件名模式识别（TASK_*、FINAL_* 等）
    - _需求: 1.3_
  
  - [x] 4.3 实现开发文档识别
    - 根据关键词识别（GUIDE、SETUP、DATABASE_ 等）
    - 根据路径识别（backend/、frontend/ 下的文档）
    - _需求: 1.5, 8.1-8.3_
  
  - [x] 4.4 实现批量分类功能
    - 对文档列表进行批量分类
    - 返回按分类分组的文档字典
    - _需求: 1.2_
  
  - [ ]* 4.5 编写分类器的属性测试
    - **属性 2: 文档分类完备性**
    - **验证: 需求 1.2**
    - 生成随机文档，验证所有文档都被分类
    
    - **属性 3: 归档关键词识别**
    - **验证: 需求 1.3**
    - 生成包含归档关键词的文档，验证被标记为归档
  
  - [ ]* 4.6 编写分类器的单元测试
    - 测试核心文档识别
    - 测试归档文档识别
    - 测试开发文档识别
    - 测试未知文档处理

- [x] 5. 检查点 - 验证扫描和分类功能
  - 确保所有测试通过，询问用户是否有问题

- [ ] 6. 实现备份管理器
  - [x] 6.1 实现备份创建功能
    - 创建备份目录（.backup/docs/）
    - 复制文档到备份目录
    - 生成备份清单（JSON 格式，记录原路径和备份路径）
    - 生成备份 ID 和时间戳
    - _需求: 11.1, 11.2_
  
  - [ ]* 6.2 编写备份的属性测试
    - **属性 19: 备份路径记录**
    - **验证: 需求 11.2**
    - 备份随机文档，验证清单记录了所有路径映射
  
  - [x] 6.3 实现恢复功能
    - 读取备份清单
    - 将文档从备份位置移回原位置
    - 验证恢复完整性
    - _需求: 11.3, 11.4_
  
  - [ ]* 6.4 编写恢复的属性测试
    - **属性 20: 恢复操作往返性**
    - **验证: 需求 11.4**
    - 整理然后恢复，验证回到原状
  
  - [x] 6.5 实现备份列表功能
    - 列出所有可用备份
    - 显示备份时间和文档数量

- [ ] 7. 实现文档移动器
  - [x] 7.1 实现目录结构创建
    - 创建 docs/ 根目录
    - 创建 docs/archive/ 子目录
    - 创建 docs/development/ 子目录
    - 创建 backend/docs/ 和 frontend/docs/ 目录
    - _需求: 2.1, 2.2, 2.3_
  
  - [x] 7.2 实现归档文档分组
    - 根据配置的分组规则创建子目录
    - 将同一模块的文档放入同一子目录
    - _需求: 3.3_
  
  - [x] 7.3 实现文档移动功能
    - 移动归档文档到 docs/archive/
    - 移动开发文档到相应目录
    - 保持核心文档不动
    - 记录移动结果（成功/失败）
    - _需求: 3.1, 3.2, 5.1-5.5_
  
  - [ ]* 7.4 编写移动器的属性测试
    - **属性 4: 核心文档位置不变性**
    - **验证: 需求 2.4, 5.1-5.5**
    - 验证核心文档整理前后路径不变
    
    - **属性 6: 归档文档移动正确性**
    - **验证: 需求 3.1**
    - 验证归档文档被移动到正确位置
    
    - **属性 7: 文件名不变性**
    - **验证: 需求 3.2**
    - 验证移动后文件名不变
    
    - **属性 9: 文档内容完整性**
    - **验证: 需求 3.5**
    - 验证移动后内容不变
    
    - **属性 10: 文档不删除保证**
    - **验证: 需求 4.5**
    - 验证系统不删除文档
  
  - [ ]* 7.5 编写移动器的单元测试
    - 测试目录创建
    - 测试文件移动
    - 测试移动失败处理

- [ ] 8. 实现索引生成器
  - [x] 8.1 实现主文档索引生成
    - 生成 docs/README.md
    - 列出所有文档分类
    - 为每个分类提供链接和说明
    - _需求: 6.1, 6.2_
  
  - [x] 8.2 实现归档索引生成
    - 生成 docs/archive/README.md
    - 按功能模块分组列出归档文档
    - 为每个文档提供描述和链接
    - 添加归档日期标记
    - _需求: 3.4, 6.5, 9.4_
  
  - [x] 8.3 实现开发文档索引生成
    - 生成各开发目录的 README.md
    - 列出该目录下的所有文档
    - 提供文档用途说明
    - _需求: 8.4_
  
  - [x] 8.4 实现 README 导航更新
    - 在项目 README.md 中添加文档导航章节
    - 使用相对路径链接
    - 按文档类型分组
    - _需求: 7.1, 7.2, 7.3, 7.4_
  
  - [ ]* 8.5 编写索引生成器的属性测试
    - **属性 11: 索引包含所有分类**
    - **验证: 需求 6.2**
    - 验证索引包含所有有效分类
    
    - **属性 12: 索引文档元数据完整性**
    - **验证: 需求 6.3, 6.4, 9.1-9.3, 9.5**
    - 验证索引包含完整元数据
    
    - **属性 13: 导航链接相对路径**
    - **验证: 需求 7.2**
    - 验证所有链接使用相对路径
    
    - **属性 15: 导航链接有效性**
    - **验证: 需求 7.5, 10.4**
    - 验证所有链接指向存在的文件
  
  - [ ]* 8.6 编写索引生成器的单元测试
    - 测试主索引生成
    - 测试归档索引生成
    - 测试链接格式
    - 测试元数据包含

- [x] 9. 检查点 - 验证核心功能完整性
  - 确保所有测试通过，询问用户是否有问题

- [ ] 10. 实现主控制器和命令行接口
  - [x] 10.1 实现 DocumentOrganizer 主控制器
    - 协调各组件执行完整流程
    - 实现错误处理和回滚机制
    - 生成操作日志和报告
    - _需求: 10.1, 10.5_
  
  - [x] 10.2 实现命令行接口
    - 支持 organize 命令（执行整理）
    - 支持 restore 命令（恢复备份）
    - 支持 list-backups 命令（列出备份）
    - 支持 validate 命令（验证配置）
    - 提供详细的帮助信息
  
  - [x] 10.3 实现操作验证和报告
    - 验证所有文档已处理
    - 生成文档清单对比报告
    - 验证链接有效性
    - 输出警告和错误信息
    - _需求: 10.1, 10.2, 10.3, 10.4_
  
  - [ ]* 10.4 编写主控制器的属性测试
    - **属性 18: 文档处理完整性**
    - **验证: 需求 10.1**
    - 验证所有文档都被处理
    
    - **属性 21: 配置规则应用**
    - **验证: 需求 12.3**
    - 修改配置后验证行为改变

- [ ] 11. 实现错误处理和日志记录
  - [x] 11.1 实现错误处理机制
    - 文件系统错误处理
    - 配置错误处理
    - 操作错误处理
    - 自动回滚机制
  
  - [x] 11.2 实现日志记录
    - 记录所有操作步骤
    - 记录错误和警告
    - 生成操作日志文件
  
  - [x]* 11.3 编写错误处理的单元测试
    - 测试各种错误场景
    - 测试回滚机制
    - 测试日志记录

- [ ] 12. 创建默认配置文件和文档
  - [x] 12.1 创建默认配置文件
    - 创建 organization_config.json
    - 包含项目特定的分类规则
    - 包含归档分组配置
  
  - [x] 12.2 创建使用文档
    - 编写 ORGANIZATION_GUIDE.md
    - 说明如何使用整理工具
    - 说明如何自定义配置
    - 提供使用示例
  
  - [x] 12.3 更新项目 README
    - 添加文档整理功能说明
    - 添加使用指南链接

- [ ] 13. 集成测试和端到端测试
  - [ ]* 13.1 编写完整流程集成测试
    - 创建模拟项目结构
    - 执行完整整理流程
    - 验证所有预期结果
    - 测试备份和恢复
  
  - [ ]* 13.2 编写错误恢复测试
    - 模拟各种错误情况
    - 验证错误处理和回滚
  
  - [ ]* 13.3 编写性能测试
    - 测试大量文档的处理性能
    - 验证性能目标达成

- [x] 14. 最终验证和文档完善
  - 运行所有测试确保通过
  - 验证在真实项目上的效果
  - 完善文档和注释
  - 生成最终报告

## 注意事项

### 实现优先级

1. **核心功能优先**: 先实现扫描、分类、移动、索引生成等核心功能
2. **测试可选**: 标记为 `*` 的测试任务可以在核心功能完成后补充
3. **增量开发**: 每完成一个主要任务后进行检查点验证

### 技术要点

1. **Python 版本**: 使用 Python 3.8+
2. **依赖库**: 
   - 标准库为主（os, shutil, json, pathlib 等）
   - pytest 用于测试
   - hypothesis 用于属性测试
3. **代码风格**: 遵循 PEP 8 规范
4. **类型注解**: 使用类型注解提高代码可读性

### 配置文件位置

- 默认配置: `organization_config.json`（项目根目录）
- 备份目录: `.backup/docs/`
- 日志文件: `organization.log`

### 测试策略

- 单元测试: 测试各组件的独立功能
- 属性测试: 验证关键正确性属性（每个测试至少 100 次迭代）
- 集成测试: 验证完整流程和错误处理
- 测试覆盖率目标: ≥ 80%

### 安全考虑

1. 操作前必须创建备份
2. 验证所有路径，防止路径遍历
3. 使用原子操作确保一致性
4. 提供恢复机制

---

**实现语言**: Python 3.8+  
**预计工作量**: 约 3-5 天  
**测试任务**: 可选（标记为 `*`），建议在核心功能完成后补充
