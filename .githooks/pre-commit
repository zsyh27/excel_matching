#!/bin/sh
# Git Pre-commit Hook - 检查临时文件
# 
# 安装方法：
#   git config core.hooksPath .githooks
#   chmod +x .githooks/pre-commit (Linux/Mac)
#
# 兼容 Windows Git Bash 和 Linux/Mac

echo "检查临时文件..."

# 获取暂存的文件列表
STAGED_FILES=$(git diff --cached --name-only)

# 检查backend目录的临时文件
TEMP_FILES=""
for file in $STAGED_FILES; do
    case "$file" in
        backend/test_*_fix.py|backend/test_*_debug.py|backend/fix_*.py|backend/check_temp_*.py|backend/demo_*.py)
            TEMP_FILES="$TEMP_FILES$file\n"
            ;;
    esac
done

if [ -n "$TEMP_FILES" ]; then
    echo "❌ 警告：检测到临时文件即将被提交："
    echo "$TEMP_FILES"
    echo ""
    echo "这些文件看起来是临时测试/修复文件。"
    echo "建议："
    echo "  1. 如果已验证完成，请删除这些文件"
    echo "  2. 如果是诊断工具，请移动到 backend/tools/"
    echo "  3. 如果确实需要提交，使用 git commit --no-verify"
    echo ""
    exit 1
fi

# 检查根目录的Python文件（排除setup.py）
ROOT_PY_FILES=""
for file in $STAGED_FILES; do
    case "$file" in
        *.py)
            # 检查是否在根目录（不包含路径分隔符）
            if ! echo "$file" | grep -q "[/\\]"; then
                if [ "$file" != "setup.py" ]; then
                    ROOT_PY_FILES="$ROOT_PY_FILES$file\n"
                fi
            fi
            ;;
    esac
done

if [ -n "$ROOT_PY_FILES" ]; then
    echo "⚠️  警告：检测到根目录的Python文件："
    echo "$ROOT_PY_FILES"
    echo ""
    echo "建议将这些文件移动到合适的目录："
    echo "  - 测试脚本 → backend/tests/"
    echo "  - 工具脚本 → backend/tools/"
    echo "  - 运维脚本 → backend/scripts/"
    echo "  - 项目脚本 → scripts/"
    echo ""
    echo "如果确实需要提交，使用 git commit --no-verify"
    echo ""
    exit 1
fi

echo "✅ 文件检查通过"
exit 0
